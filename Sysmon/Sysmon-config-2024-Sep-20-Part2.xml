<Sysmon schemaversion="4.9">
<EventFiltering>

<!--
Add this part to part 1.


Driver Load
-->

    <DriverLoad onmatch="include"/>   
	<DriverLoad onmatch="exclude">
      <Signature condition="begin with">Intel</Signature>
      <Signature condition="contains">microsoft</Signature>
      <Signature condition="contains">windows</Signature>
    </DriverLoad>
	
<!--
Image Load          
-->

    <ImageLoad onmatch="include">
	  <Image>c:\Windows\System32\taskhostw.exe</Image> <!-- persistence - backdoor existing system scheduled taskschd pay attention to unsigned or loaded module with invalid signature -->
	  <ImageLoaded condition="end with" name="Execution - Suspicious WMI module load">wmiutils.dll</ImageLoaded>
	  <ImageLoaded condition="end with" name="Execution - Suspicious Microsoft.XMLDOM module load">msxml3.dll</ImageLoaded>
	  <ImageLoaded condition="end with" name="Execution - Suspicious Schedule.Service Module Load">taskschd.dll</ImageLoaded>
	  <!-- known bad dll names -->
	  <ImageLoaded condition="end with">rdpwrap.dll</ImageLoaded> <!-- RDP Setting hijack - https://github.com/stascorp/rdpwrap -->
	  <ImageLoaded condition="end with" name="Possible UAC Bypass - DiskCleanup">logprovider.dll</ImageLoaded> <!-- Win10 UAC Bypass via DiskCleanup loading a rogue DISM DLL -->
	  <ImageLoaded condition="end with" name="Possible UAC Bypass - mcx2prov DLL">CRYPTBASE.dll</ImageLoaded> <!-- UAC Bypass via mcx2prov executable and rogue CRYPTBASE.dll-->
	  <!-- Invalid signatures -->
	  <SignatureStatus condition="is" name="dll with invalid signature detected">Invalid</SignatureStatus>
	  <!-- abnormal loaded module file extension -->
	  <ImageLoaded condition="end with">.png</ImageLoaded>
	  <ImageLoaded condition="end with">.jpg</ImageLoaded>
	  <ImageLoaded condition="end with">.dat</ImageLoaded>
	  <ImageLoaded condition="end with">.tmp</ImageLoaded>
	  <ImageLoaded condition="end with">.inf</ImageLoaded>
	  <ImageLoaded condition="end with">.ini</ImageLoaded>
	  <ImageLoaded condition="end with">.log</ImageLoaded>
	  <!-- Office Addins -->
	  <ImageLoaded condition="end with">.wll</ImageLoaded>
	  <ImageLoaded condition="end with">.xll</ImageLoaded>
	  <!-- Unmanaged PowerShell -->
	  <ImageLoaded condition="end with" name="Defense Evasion - Unmanaged PowerShell Detected">system.management.automation.ni.dll</ImageLoaded>
	  <ImageLoaded condition="end with" name="Defense Evasion - Unmanaged PowerShell Detected">system.management.automation.dll</ImageLoaded>
	  
	  <!-- Module loaded from uncommon location -->
	  <ImageLoaded condition="begin with">\\</ImageLoaded><!-- loaded from network file share -->
	  <ImageLoaded condition="contains">admin$</ImageLoaded><!-- loaded from network file share -->
	  <ImageLoaded condition="contains">c$</ImageLoaded><!-- loaded from network file share -->
	  <ImageLoaded condition="contains">\appdata\</ImageLoaded>
	  <ImageLoaded condition="contains">\temp\</ImageLoaded>
	  <ImageLoaded condition="begin with">c:\programdata\</ImageLoaded>
	  <ImageLoaded condition="begin with" >C:\Windows\Media\</ImageLoaded>
      <ImageLoaded condition="begin with" >C:\Windows\addins\</ImageLoaded>
	  <ImageLoaded condition="begin with" >C:\Windows\system32\config\systemprofile\</ImageLoaded>
	  <ImageLoaded condition="begin with" >C:\Windows\Debug\</ImageLoaded> 
	  <ImageLoaded condition="begin with" >C:\Windows\Temp</ImageLoaded>
      <ImageLoaded condition="begin with" >C:\PerfLogs\</ImageLoaded>
	  <ImageLoaded condition="begin with" >C:\Windows\Help\</ImageLoaded>
	  <ImageLoaded condition="begin with" >C:\Intel\Logs\</ImageLoaded>
	  <ImageLoaded condition="begin with">C:\Temp</ImageLoaded>
      <ImageLoaded condition="begin with" >C:\Windows\repair\</ImageLoaded>
      <ImageLoaded condition="begin with" >C:\Windows\security\</ImageLoaded>
      <ImageLoaded condition="begin with" >C:\Windows\Fonts\</ImageLoaded>
	  <ImageLoaded condition="begin with">file:</ImageLoaded>
	  <ImageLoaded condition="contains">$Recycle.bin\</ImageLoaded>
	  <ImageLoaded condition="contains">\Windows\IME\</ImageLoaded>	  
	  
	  <!-- DLL Side Loading - Bring Your Own Vulnerability - http://www.hexacorn.com/blog/2016/0/page/31/-->
	  
	  <ImageLoaded condition="end with">NvSmartMax.dll</ImageLoaded> <!--https://quequero.org/2013/09/quick-analysissome-observation-about-a-low-detection-flash_update-exe/ -->
	  <ImageLoaded condition="end with">Duser.dll</ImageLoaded> <!-- https://app.any.run/tasks/3fcfd265-ef80-4749-a24b-39364a079802 loaded by credwiz.exe -->
      <ImageLoaded condition="end with">AShldRes.DLL</ImageLoaded>
      <ImageLoaded condition="end with">CommFunc.dll</ImageLoaded>
      <ImageLoaded condition="end with">chrome_frame_helper.dll</ImageLoaded>
      <ImageLoaded condition="end with">DESqmWrapper.dll</ImageLoaded>
      <ImageLoaded condition="end with">fslapi.dll</ImageLoaded>
      <ImageLoaded condition="end with">FSPMAPI.dll</ImageLoaded>
      <ImageLoaded condition="end with">Sidebar.dll</ImageLoaded>
      <ImageLoaded condition="end with">hha.dll</ImageLoaded>
      <ImageLoaded condition="end with">hccutils.dll</ImageLoaded>
      <ImageLoaded condition="end with">NtUserEx.dll</ImageLoaded>
      <ImageLoaded condition="end with">McUtil.dll</ImageLoaded>
      <ImageLoaded condition="end with">MpSvc.dll</ImageLoaded>
      <ImageLoaded condition="end with">mPclient.dll</ImageLoaded>
      <ImageLoaded condition="end with">NvSmartMax.dll</ImageLoaded>
      <ImageLoaded condition="end with">OInfo11.ocx</ImageLoaded>
      <ImageLoaded condition="end with">ACLUI.DLL</ImageLoaded>
      <ImageLoaded condition="end with">iviewers.dll</ImageLoaded>
      <ImageLoaded condition="end with">NtUserEx.dll</ImageLoaded>
      <ImageLoaded condition="end with">RasTls.dll</ImageLoaded>
      <!-- https://www.hybrid-analysis.com/sample/0fb0636a2823e8fb63681b6bf9d1dd910c7a1e3ed27d19fda1db11dda8e578f8?environmentId=100 -->
      <ImageLoaded condition="end with">rc.dll</ImageLoaded>
      <ImageLoaded condition="end with">ssMUIDLL.dll</ImageLoaded>
      <ImageLoaded condition="end with">winmm.dll</ImageLoaded>
      <ImageLoaded condition="end with">msi.dll</ImageLoaded>
      <ImageLoaded condition="end with">Ushata.dll</ImageLoaded>
      <ImageLoaded condition="end with">libvlc.dll</ImageLoaded>
      <ImageLoaded condition="end with">AhnI2.dll</ImageLoaded>
	  <ImageLoaded condition="end with" name="Evasion - Possible DLL Side Loading via jjs.exe">jli.dll</ImageLoaded>
	  <!-- https://www.microsoft.com/security/blog/2018/03/01/finfisher-exposed-a-researchers-tale-of-defeating-traps-tricks-and-complex-virtual-machines/ -->
	  <ImageLoaded condition="end with">sspisrv.dll</ImageLoaded>
	  <ImageLoaded condition="end with">ftllib.dll</ImageLoaded>
	  <ImageLoaded condition="end with">userenv.dll</ImageLoaded>
    </ImageLoad>
	
	<!-- ImageLoad Exclusion config-section - always depend on ur own env, good luck with that -->
    <ImageLoad onmatch="exclude">
	  <!-- <SignatureStatus>Valid</SignatureStatus> --> <!-- good for a better visibility on unsigned modules loading -->
	  <Image>C:\Program Files\Microsoft Policy Platform\policyHost.exe</Image>
	  <ImageLoaded>C:\Windows\System32\cryptbase.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\System32\amsi.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\System32\msi.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\System32\userenv.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\System32\winmm.dll</ImageLoaded>
	  <ImageLoaded condition="end with">.exe</ImageLoaded>
	  <Image>C:\Windows\System32\dllhost.exe</Image>
	  <Image condition="end with">powershell.exe</Image>
	  <Image>C:\Windows\System32\DeviceCensus.exe</Image>
	  <Image>C:\Windows\System32\systeminfo.exe</Image>
	  <Image>C:\Windows\System32\LockAppHost.exe</Image>
	  <Image>C:\Program Files\Google\Update\GoogleUpdate.exe</Image>
	  <Hashes condition="end with">AA02A4789AEBC104EA53E559F824A5B4</Hashes> <!-- IMPHASH of OneDriveStandaloneUpdater.exe -->
	  <Image condition="end with">powershell_ise.exe</Image>
	  <Hashes condition="end with">727B32239F3556C6C9E82ADE6087C4AC</Hashes><!-- Microsoft OneDrive Shell Extension -->
	  <!--<Image condition="begin with">C:\Program Files\Microsoft Office\root\</Image>-->
	  <Image>C:\Windows\System32\wbem\WmiPrvSE.exe</Image>
	  <Image>C:\Windows\System32\SrTasks.exe</Image>
	  <Image condition="end with">DismHost.exe</Image>
	  <Image condition="begin with">C:\Windows\Microsoft.NET\Framework\</Image>
	  <Image>C:\Windows\System32\wbem\WmiApSrv.exe</Image>
	  <Image>C:\Windows\SysWOW64\wbem\WmiPrvSE.exe</Image>
	  <Image>C:\Program Files\Microsoft Policy Platform\policyHost.exe</Image>
	  <Image>C:\Windows\System32\SearchProtocolHost.exe</Image>
	  <Image>C:\Windows\System32\SearchFilterHost.exe</Image>
	  <Image>C:\Windows\System32\backgroundTaskHost.exe</Image>
	  <Image>C:\Windows\servicing\TrustedInstaller.exe</Image>
	  <Image condition="begin with">C:\Windows\System32\taskhost</Image>
	  <Image>C:\Windows\System32\LogonUI.exe</Image>
	  <Image>C:\Windows\System32\wifitask.exe</Image>
	  <Image>C:\Program Files\Microsoft Data Protection Manager\DPM\bin\DPMRA.exe</Image>
	  <Image>C:\Windows\System32\VSSVC.exe</Image>
	  <Image>C:\Windows\System32\netsh.exe</Image>
	  <Image>C:\Users\sbousseaden\AppData\Local\Microsoft\Teams\current\Teams.exe</Image>
	  <Image>C:\Program Files (x86)\Google\Chrome\Application\chrome.exe</Image>
	  <Image>C:\Windows\System32\raserver.exe</Image>
	  <Image>C:\Windows\System32\RuntimeBroker.exe</Image>
	  <Image condition="begin with">C:\Windows\SystemApps\</Image>
	  <Image>C:\Windows\System32\SearchIndexer.exe</Image>
	  <Image>C:\Windows\explorer.exe</Image>
	  <Image>C:\Windows\System32\sppsvc.exe</Image><!-- noisy for taskschd.dll-->
	  <Image>C:\Program Files\Internet Explorer\iexplore.exe</Image>
	  <Image condition="begin with">C:\Windows\CCM\</Image>
	  <Image>C:\Program Files\Manufacturer\Endpoint Agent\edpa.exe</Image>
	  <!--<Image condition="begin with">C:\Program Files\Microsoft Office\</Image>-->
	  <Image>C:\Program Files\Microsoft Data Protection Manager\DPM\bin\DPMClientService.exe</Image>
	  <Image condition="begin with">C:\Program Files (x86)\Microsoft Visual Studio\</Image>
	  <Image>C:\Windows\System32\provtool.exe</Image>
	  <Image>C:\Program Files\CONEXANT\SA3\HP-NB-AIO\SmartAudio3.exe</Image>
	  <Image>C:\Windows\System32\mmc.exe</Image>
	  <Image>C:\Program Files\Synaptics\SynTP\SynTPEnh.exe</Image>
	  <Image>C:\Windows\System32\wlanext.exe</Image>
	  <Image condition="begin with">C:\Program Files\Microsoft SQL Server\</Image>
	  <Image>C:\Windows\System32\ibtsiva.exe</Image>
	  <Image>C:\Windows\System32\lsass.exe</Image>
	  <Image>C:\Windows\System32\dwm.exe</Image>
	  <Image>C:\Windows\System32\MicTray64.exe</Image>
	  <Image>C:\Program Files\Intel\WiFi\bin\EvtEng.exe</Image>
	  <Image>C:\Program Files\Intel\WiFi\bin\iWrap.exe</Image>
	  <Image>C:\Program Files\Microsoft SQL Server\90\Shared\sqlwriter.exe</Image>
	  <Image condition="begin with">C:\Program Files\WindowsApps\</Image>
	  <Image>C:\Windows\System32\SystemSettingsBroker.exe</Image>
	  <Image>C:\Windows\System32\smartscreen.exe</Image>
	  <Image>C:\Windows\System32\services.exe</Image>
	  <Image>C:\Windows\System32\CompatTelRunner.exe</Image>
	  <Image condition="begin with">C:\Program Files\Microsoft Forefront Identity Manager\</Image>
	  <Image>C:\Windows\System32\sihost.exe</Image>
	  <Image>C:\Program Files\Common Files\microsoft shared\ClickToRun\OfficeClickToRun.exe</Image>
	  <Image>C:\Windows\System32\SettingSyncHost.exe</Image>
	  <Image>c:\windows\system32\schtasks.exe</Image>
	  <Image>c:\windows\syswow64\schtasks.exe</Image>
	  <Image>c:\windows\system32\svchost.exe</Image>
	  <Image>c:\windows\syswow64\svchost.exe</Image>
	  <Image>C:\Program Files (x86)\Kontiki\KHost.exe</Image>
	  <Image>C:\Windows\System32\tasklist.exe</Image>
	  <Image>C:\Program Files (x86)\Google\Update\GoogleUpdate.exe</Image>
	  <Image condition="end with">procexp64.exe</Image>
	  <Image condition="end with">procmon.exe</Image>
	  <Image condition="end with">procexp.exe</Image>
	  <Image condition="end with">wmic.exe</Image>
	  <Image condition="end with">AppData\Local\Microsoft\OneDrive\OneDrive.exe</Image>
	  <ImageLoaded condition="begin with">C:\ProgramData\Microsoft\Windows Defender\Platform\</ImageLoaded>
	  <Image condition="end with">AppData\Local\Microsoft\Teams\Update.exe</Image>
	  <Image>C:\Windows\System32\ClipRenew.exe</Image>
	  <ImageLoaded>C:\Windows\SysWOW64\msi.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\SysWOW64\cryptbase.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\System32\aclui.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\System32\syswow64.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\SysWOW64\userenv.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\SysWOW64\winmm.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\System32\winmm.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\System32\duser.dll</ImageLoaded>
	  <ImageLoaded>C:\Windows\Syswow64\duser.dll</ImageLoaded>
	  <ImageLoaded>C:\Program Files\Windows Defender\MpClient.dll</ImageLoaded>
	  <Signature>Opera Software AS</Signature>
	</ImageLoad>
	
<!--
Create Remote Threads                                                                                                                      
-->

	<!-- CreateRemoteThread - Exclusion Section, capturing this event is important be careful when excluding stuff  -->
	
    <CreateRemoteThread onmatch="exclude">
	  <SourceImage condition="begin with">C:\Program Files\HP Inc\</SourceImage>
	  <SourceImage condition="begin with">C:\Program Files (x86)\Trend Micro\</SourceImage>
      <SourceImage >C:\Windows\System32\wbem\WmiPrvSE.exe</SourceImage>
	  <SourceImage>C:\Windows\SysWOW64\wbem\WmiPrvSE.exe</SourceImage> 
      <SourceImage>C:\Windows\System32\svchost.exe</SourceImage>
      <SourceImage>C:\Windows\System32\services.exe</SourceImage>
      <SourceImage>C:\Windows\System32\audiodg.exe</SourceImage>
      <SourceImage>C:\Windows\System32\csrss.exe</SourceImage>
	  <SourceImage>C:\WINDOWS\Explorer.EXE</SourceImage>
	  <SourceImage>C:\Program Files\Trend Micro\AMSP\coreServiceShell.exe</SourceImage>
      <SourceImage>C:\Windows\System32\winlogon.exe</SourceImage>
      <SourceImage>C:\Windows\System32\wininit.exe</SourceImage>
      <TargetImage condition="end with">Google\Chrome\Application\chrome.exe</TargetImage>
      <StartModule>C:\windows\system32\kernel32.dll</StartModule>
	  <SourceImage>C:\Program Files (x86)\Webroot\WRSA.exe</SourceImage>
	  <StartFunction>EtwpNotificationThread</StartFunction><!-- observed as FP from -->
	  <StartFunction>RtlpQueryProcessDebugInformationRemote</StartFunction><!-- observed as a FP from procexp64.exe -->
    </CreateRemoteThread>
<!--
Raw Access Read 
-->

    <RawAccessRead onmatch="include" />
    
<!--
Process Access 
-->

    <ProcessAccess onmatch="include">
	<GrantedAccess name="Defense Evasion - Possible Process Suspended" condition="is">0x800</GrantedAccess><!-- minimum required OpenProcess access rights to suspend a target process -->
	<SourceImage condition="end with">jjs.exe</SourceImage>
	<SourceImage condition="end with">cscript.exe</SourceImage>
	<TargetImage condition="end with">:\Windows\System32\lsass.exe</TargetImage>
	<TargetImage condition="end with">:\Windows\System32\winlogon.exe</TargetImage>
	<SourceImage condition="contains">powershell.exe</SourceImage>
	<TargetImage condition="end with">:\Windows\Syswow64\</TargetImage>
	<TargetImage condition="contains">verclsid.exe</TargetImage>
	<CallTrace condition="contains">VBE7.dll</CallTrace>
	<CallTrace condition="contains">CorperfmontExt.dll</CallTrace>
	<CallTrace condition="contains">UNKNOWN</CallTrace>
	<CallTrace condition="contains">System.Management.Automation.ni.dll</CallTrace><!-- not good if u see source image is not powershell.exe -->
	<SourceImage condition="begin with">c:\users\</SourceImage><!-- if too noisy, replace it with AppData and contains as condition -->
	<SourceImage condition="begin with">c:\programdata\</SourceImage>
	<SourceImage condition="begin with" >C:\Windows\Media\</SourceImage>
    <SourceImage condition="begin with" >C:\Windows\addins\</SourceImage>
	<SourceImage condition="begin with" >C:\Windows\system32\config\systemprofile\</SourceImage>
	<SourceImage condition="begin with" >C:\Windows\Debug\</SourceImage> 
	<SourceImage condition="begin with" >C:\Windows\Temp</SourceImage>
    <SourceImage condition="begin with" >C:\PerfLogs\</SourceImage>
	<SourceImage condition="begin with" >C:\Windows\Help\</SourceImage>
	<SourceImage condition="begin with" >C:\Intel\Logs\</SourceImage>
	<SourceImage condition="begin with">C:\Temp</SourceImage>
    <SourceImage condition="begin with" >C:\Windows\repair\</SourceImage>
	<SourceImage condition="begin with" >C:\ProgramData</SourceImage>
    <SourceImage condition="begin with" >C:\Windows\security\</SourceImage>
    <SourceImage condition="begin with" >C:\Windows\Fonts\</SourceImage>
	<SourceImage condition="begin with" >C:\$Recycle.bin\</SourceImage>
	<SourceImage condition="contains">\Windows\IME\</SourceImage>
	<SourceImage condition="contains">AppData\Local\Programs\Opera</SourceImage>
	</ProcessAccess>

<!-- ProcessAccess Exclusion Section, depends on ur own env -->
   
    <ProcessAccess onmatch="exclude">
	  <SourceImage condition="begin with">C:\ProgramData\Microsoft\Windows Defender\platform\</SourceImage>
	  <SourceImage condition="is">C:\Windows\system32\svchost.exe</SourceImage>
	  <SourceImage condition="is">C:\Windows\system32\spoolsv.exe</SourceImage>
	  <SourceImage condition="is">C:\Program Files\Manufacturer\Endpoint Agent\edpa.exe</SourceImage><!-- symantec dlp -->
	  <SourceImage condition="begin with">C:\Windows\syswow64\</SourceImage>
	  <SourceImage condition="is">C:\Program Files (x86)\N-able Technologies\Windows Agent\bin\agent.exe</SourceImage>
	  <SourceImage condition="is">C:\Program Files\N-able Technologies\AVDefender\EPUpdateService.exe</SourceImage>
	  <SourceImage condition="end with">\EMET_Service.exe</SourceImage>
	  <SourceImage condition="end with">\EMET_GUI.exe</SourceImage>
      <SourceImage condition="end with">\procexp64.exe</SourceImage>
	  <SourceImage condition="end with">\procmon64.exe</SourceImage>
	  <SourceImage condition="end with">\software_reporter_tool.exe</SourceImage>
	  <SourceImage condition="end with">NGenTask.exe</SourceImage>
	  <SourceImage condition="end with">Autoruns.exe</SourceImage>
	  <SourceImage condition="end with">Autorunsc.exe</SourceImage>
	  <SourceImage condition="contains">processhacker</SourceImage>
	  <SourceImage condition="end with">\Bin\FMS.exe</SourceImage> <!-- Exchange Process -->
	  <SourceImage condition="end with">:\Windows\System32\smss.exe</SourceImage>
	  <SourceImage condition="end with">\Google\Update\GoogleUpdate.exe</SourceImage>
	  <SourceImage condition="is">C:\Program Files\Trend Micro\AMSP\coreServiceShell.exe</SourceImage>
	  <SourceImage condition="is">C:\Program Files (x86)\Webroot\WRSA.exe</SourceImage>
	  <SourceImage condition="is">C:\Program Files\Webroot\WRSA.exe</SourceImage>
	  <SourceImage condition="is">C:\Program Files\Windows Defender\MsMpEng.exe</SourceImage>
	  <TargetImage condition="is">C:\Windows\Sysmon.exe</TargetImage>
	  <TargetImage condition="is">C:\Windows\Sysmon64.exe</TargetImage>
	  <TargetImage condition="end with">csc.exe</TargetImage>
	  <!-- These binaries get or access processes running .NET -->
	  <SourceImage condition="end with">:\Windows\system32\sppsvc.exe</SourceImage>
	  <SourceImage condition="end with">:\Windows\system32\sdiagnhost.exe</SourceImage>
	  <!-- In testing a common false-positive is memory space that DLLS would be expected to mapped to. -->
	  <SourceImage condition="end with">Common Files\Adobe\ARM\1.0\AdobeARMHelper.exe</SourceImage>
	  <SourceImage condition="end with">Common Files\Adobe\AdobeGCClient\AGSService.exe</SourceImage>
	  <SourceImage condition="begin with">C:\ProgramData\WebEx\webex\</SourceImage>
	  <SourceImage condition="end with">Dropbox\Update\DropboxUpdate.exe</SourceImage>
	  <SourceImage condition="end with">LTSvc\LTSVC.exe</SourceImage>
	  <SourceImage condition="end with">\Trusteer\Rapport\bin\RapportMgmtService.exe</SourceImage>
	  <SourceImage condition="end with">Adobe\AdobeGCClient\AGMService.exe</SourceImage>
	  <SourceImage condition="end with">NT-ware Shared\MomAdmSvc\MomAdmSvc.exe</SourceImage>
	  <SourceImage condition="end with">\Autodesk\Autodesk Desktop App\AdAppMgrSvc.exe</SourceImage>
	  <SourceImage>c:\windows\system32\wbem\wmiprvse.exe</SourceImage>
	  <SourceImage condition="is">C:\Windows\sysWOW64\wbem\wmiprvse.exe</SourceImage>
	  <SourceImage condition="end with">vmtoolsd.exe</SourceImage>
	  <SourceImage condition="end with">VBoxService.exe</SourceImage>
      <SourceImage condition="end with">LTSVC.exe</SourceImage>
      <SourceImage condition="end with">taskmgr.exe</SourceImage>
	  <SourceImage condition="end with">procexp64.exe</SourceImage>
	  <SourceImage condition="end with">procmon.exe</SourceImage>
	  <SourceImage condition="end with">procexp.exe</SourceImage> 
	  <SourceImage>C:\Windows\system32\csrss.exe</SourceImage> 
	  <SourceImage>C:\Windows\system32\wininit.exe</SourceImage> 
	  <SourceImage>C:\Windows\System32\lsm.exe</SourceImage>
	  <SourceImage>C:\Windows\system32\MRT.exe</SourceImage> 
	  <SourceImage condition="end with">\Citrix\System32\wfshell.exe</SourceImage> 
	  <SourceImage>C:\Program Files (x86)\Kontiki\KService.exe</SourceImage>
	  <SourceImage>C:\Windows\system32\dgagent\DSAGENT.exe</SourceImage>
	  <SourceImage>C:\Program Files (x86)\BigFix Enterprise\BES Client\BESClient.exe</SourceImage>
	  <SourceImage condition="begin with">C:\ProgramData\Microsoft\Windows Defender\platform\</SourceImage>
	  <SourceImage>C:\Program Files\Trend Micro\Deep Security Agent\dsa.exe</SourceImage> 
	  <SourceImage condition="end with">AppData\Local\Microsoft\Teams\current\Teams.exe</SourceImage>
	  <SourceImage condition="end with">Microsoft.Identity.AadConnect.Health.AadSync.Host.exe</SourceImage>
	  <SourceImage>C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client\vpnagent.exe</SourceImage>
	  <SourceImage condition="end with">Commvault\ContentStore\Base\cvd.exe</SourceImage>
	  <SourceImage condition="is">C:\Program Files (x86)\Webroot\WRSA.exe</SourceImage>
	  <SourceImage condition="is">C:\Program Files\Webroot\WRSA.exe</SourceImage>
	  <SourceImage condition="is">C:\Program Files\Windows Defender\MsMpEng.exe</SourceImage>
	  <TargetImage condition="is">C:\Program Files\Windows Defender\MsMpEng.exe</TargetImage>
	  <SourceImage>C:\WINDOWS\system32\NETSTAT.EXE</SourceImage>
	  <SourceImage>C:\WINDOWS\CCM\CcmExec.exe</SourceImage>
	  <SourceImage condition="begin with">C:\Program Files\HP Inc\</SourceImage>
	  <SourceImage condition="begin with">C:\Program Files (x86)\Trend Micro\</SourceImage>
	  <SourceImage condition="begin with">C:\Program Files (x86)\Symantec\Symantec Endpoint Protection</SourceImage> 
	  <SourceImage>C:\Windows\System32\msiexec.exe</SourceImage> <!-- temp -->
	  <SourceImage>C:\Program Files\Internet Explorer\iexplore.exe</SourceImage> <!-- temp -->
      <CallTrace condition="contains">windows defender</CallTrace> <!-- windefender -->
	  <CallTrace condition="contains">mpengine.dll</CallTrace> <!-- Windefender -->
	  <CallTrace condition="contains">UNKNOWN(00007F</CallTrace>
	  <CallTrace condition="contains">appresolver.dll</CallTrace>
	  <CallTrace condition="contains">sysmain.dll</CallTrace>
	  <GrantedAccess condition="is">0x40</GrantedAccess><!-- noisy -->
	  <GrantedAccess condition="end with">0x1000</GrantedAccess><!-- generic access rights -->
	  <GrantedAccess condition="end with">0x1400</GrantedAccess><!-- generic access rights -->
	  <GrantedAccess condition="is">0x3200</GrantedAccess><!-- generic access rights -->
	  <GrantedAccess condition="end with">0x101000</GrantedAccess><!-- generic access rights -->
	  <GrantedAccess condition="end with">0x101001</GrantedAccess> <!-- generic access rights -->
	  <GrantedAccess condition="end with">0x100000</GrantedAccess><!-- generic access rights -->
	  <GrantedAccess condition="end with">0x101400</GrantedAccess><!-- generic access rights -->
	  <GrantedAccess condition="end with">0x100040</GrantedAccess><!-- generic access rights -->
	  <GrantedAccess condition="end with">0x1000000</GrantedAccess><!-- generic access rights -->
    </ProcessAccess>
	
<!--
File Create
-->
    <FileCreate onmatch="include">	
	  <!-- default windows services set to start automatically and under SYSTEM user context -->
	  <TargetFilename condition="end with">trustedInstaller.exe</TargetFilename>
	  <TargetFilename condition="end with">SDXHelper.exe</TargetFilename>
	  <TargetFilename condition="end with">dsagent.exe</TargetFilename>
	  <TargetFilename condition="end with">wsqmcons.exe</TargetFilename>
	  <TargetFilename condition="end with">diagtrackrunner.exe</TargetFilename>
	  <TargetFilename condition="end with">DPMRA.exe</TargetFilename> <!-- Microsoft Data Protection Manager -->
	  <TargetFilename condition="end with">ceipdata.exe</TargetFilename>
	  <TargetFilename condition="end with">ServerManagerLauncher.exe</TargetFilename>
	  <TargetFilename condition="end with">msiexec.exe</TargetFilename> <!-- unlikely for stability reasons, default related service cmdline is msiexe /v -->
	  <TargetFilename condition="end with">VSSVC.exe</TargetFilename> <!-- unlikely for stability reason -->
	  <TargetFilename condition="end with">OfficeClickToRun.exe</TargetFilename>
	  <TargetFilename condition="end with">wlms.exe</TargetFilename>
	  <TargetFilename condition="end with">spoolsv.exe</TargetFilename> <!-- unlikely for stability reasons -->
	  <TargetFilename condition="end with">ibtsiva.exe</TargetFilename><!-- Intel -->
	  <TargetFilename condition="end with">fpcsevtsvc.exe</TargetFilename>
	  <TargetFilename condition="end with">vds.exe</TargetFilename>
	  <TargetFilename condition="end with">ceiprole.exe</TargetFilename>
	  <TargetFilename condition="end with">vdsldr.exe</TargetFilename>
	  <TargetFilename condition="end with">TSTheme.exe</TargetFilename>
	  <TargetFilename condition="end with">printfilterpipelinesvc.exe</TargetFilename>
	  <TargetFilename condition="end with">GoogleUpdate.exe</TargetFilename>
	  <TargetFilename condition="end with">dosvc.dll</TargetFilename>
	  <TargetFilename condition="end with">wuauserv.dll</TargetFilename>
	  <TargetFilename condition="end with">WebClient.dll</TargetFilename>
	  <TargetFilename condition="end with">wbiosrvc.dll</TargetFilename>
	  <TargetFilename condition="end with">wpnservice.dll</TargetFilename>
	  <TargetFilename condition="end with">wwansvc.dll</TargetFilename>
	  <TargetFilename condition="end with">themeservice.dll</TargetFilename>
	  <TargetFilename condition="end with">sysmain.dll</TargetFilename>
	  <TargetFilename condition="end with">wiaservc.dll</TargetFilename>
	  <TargetFilename condition="end with">certprop.dll</TargetFilename>
	  <TargetFilename condition="end with">tileobjserver.dll</TargetFilename>
	  <TargetFilename condition="end with">pcasvc.dll</TargetFilename>
	  <TargetFilename condition="end with">regsrvc.exe</TargetFilename><!-- Intel -->  
	  <!-- default windows scheduled tasks binaries replacement -->
	  <TargetFilename condition="end with">.au3</TargetFilename> <!-- autoit script -->
      <Image>C:\WINDOWS\system32\wbem\scrcons.exe</Image><!-- wmi acttivescripteventconsumer persist -->
      <TargetFilename condition="end with">.dmp</TargetFilename><!-- memory dump --> 
	  <TargetFilename condition="contains">AppData\Local\Microsoft\CLR_v2.0\UsageLogs\</TargetFilename><!-- temp -->
	  <TargetFilename condition="end with" name="Execution - Susp ManagedCode Host Process">\UsageLogs\cscript.exe.log</TargetFilename> <!-- suspicious NET executions -->
	  <TargetFilename condition="end with" name="Execution - Susp ManagedCode Host Process">\UsageLogs\wmic.exe.log</TargetFilename> <!-- suspicious NET executions -->
	  <TargetFilename condition="end with" name="Execution - Susp ManagedCode Host Process">\UsageLogs\mshta.exe.log</TargetFilename> <!-- suspicious NET executions -->
	  <TargetFilename condition="end with" name="Execution - Susp ManagedCode Host Process">\UsageLogs\svchost.exe.log</TargetFilename> <!-- suspicious NET executions -->
	  <TargetFilename condition="end with" name="Execution - Susp ManagedCode Host Process">\regsvr32.exe.log</TargetFilename> <!-- suspicious NET executions -->
	  <TargetFilename condition="end with" name="Execution - Susp ManagedCode Host Process">\UsageLogs\rundll32.exe.log</TargetFilename> <!-- suspicious NET executions -->
	  <TargetFilename condition="end with">.mof</TargetFilename> <!-- wmi persistence -->
	  <TargetFilename condition="end with">.xsl</TargetFilename> <!-- XML Script -->
	  <TargetFilename condition="end with">wscript.exe</TargetFilename><!-- UAC Bypass via rogue manifest -->
	  <TargetFilename condition="end with">.manifest</TargetFilename> <!-- UAC Bypass via custom manifest targeting vulnerable trusted programs -->
	  <TargetFilename condition="end with" name="Discovery - BloodHound Detected">bloodhound.bin</TargetFilename> <!-- by default bloodhound drops this file to disk if not disabled by cmdline -->
	  <TargetFilename condition="end with">.url</TargetFilename>
	  <TargetFilename condition="end with">.dll</TargetFilename> <!-- DLLs -->
	  <TargetFilename condition="end with">.msi</TargetFilename> <!-- msi pkg -->
	  <TargetFilename condition="end with">.au3</TargetFilename> <!-- autoit script -->
	  <TargetFilename condition="end with">.wcx</TargetFilename> <!-- total commander plugin -->
	  <TargetFilename condition="end with">.sdb</TargetFilename> <!-- persist or hijack exec flow via appcompat shim database -->
	  <TargetFilename condition="end with">.wbk</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.wiz</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.dot</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.rtf</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.xlsm</TargetFilename> <!-- hello i have some macro -->
	  <TargetFilename condition="end with">.iqy</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.slk</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with" name="Excel VBA AddIn">.xla</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with" name="Excel VBA AddIn">.xlam</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with" name="PowerPoint VBA AddIn">.ppa</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with" name="PowerPoint VBA AddIn">.ppam</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with" name="Persistence - Outlook VBA Backdoor">VBAProject.OTM</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.xld</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.xlk</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.xll</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.xlm</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.xlsb</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.xlt</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.xlt</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.xlw</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.dotx</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.potx</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.sldx</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.xltx</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.xlw</TargetFilename> <!-- office less famous extensions -->
	  <TargetFilename condition="end with">.vcs</TargetFilename> <!-- outlook file -->
	  <TargetFilename condition="end with">.pst</TargetFilename> <!-- outlook file -->
	  <TargetFilename condition="end with">.ost</TargetFilename> <!-- outlook file -->
	  <TargetFilename condition="end with">.ics</TargetFilename> <!-- outlook file -->
	  <TargetFilename condition="end with">.oab</TargetFilename> <!-- outlook file -->
	  <TargetFilename condition="end with">.nst</TargetFilename> <!-- outlook file -->
	  <TargetFilename condition="end with">.msg</TargetFilename> <!-- outlook file -->
      <TargetFilename condition="end with" >.vbe</TargetFilename>
      <TargetFilename condition="end with">.vb</TargetFilename>
	  <TargetFilename condition="end with">.csproj</TargetFilename> <!-- https://github.com/infosecn1nja/MaliciousMacroMSBuild -->
	  <TargetFilename condition="end with">.bin</TargetFilename>
	  <TargetFilename condition="end with" name="Chrome extension file detected">.crx</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\Tasks\</TargetFilename>
	  <TargetFilename condition="begin with">c:\windows\system32\tasks\</TargetFilename>
      <TargetFilename condition="end with">.ps1</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\System32\Wbem</TargetFilename>
      <TargetFilename condition="end with">.wll</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\AppPatch\Custom</TargetFilename>
	  <TargetFilename condition="begin with">c:\windows\AppPatch64\Custom</TargetFilename>
	  <TargetFilename condition="end with">.jar</TargetFilename>
      <TargetFilename condition="begin with">C:\Users\Default</TargetFilename>
      <TargetFilename condition="end with">.docm</TargetFilename>
      <TargetFilename condition="end with">.vbs</TargetFilename>
      <TargetFilename condition="end with">.pyw</TargetFilename>
	  <TargetFilename condition="end with">.pyd</TargetFilename>
	  <TargetFilename condition="end with">.pyc</TargetFilename>
	  
	  <!-- common compressed files -->
	  <TargetFilename condition="end with">.cab</TargetFilename>
	  <TargetFilename condition="end with">.rar</TargetFilename>
	  <TargetFilename condition="end with">.zip</TargetFilename>
	  <TargetFilename condition="end with">.7z</TargetFilename>
	  
      <TargetFilename condition="contains">\Downloads\</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\System32\GroupPolicy\User\Scripts</TargetFilename>
      <TargetFilename condition="end with">.hta</TargetFilename>
      <TargetFilename condition="end with">.lnk</TargetFilename>
      <TargetFilename condition="end with">.appref-ms</TargetFilename>
      <TargetFilename condition="end with">.scf</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\System32\GroupPolicy\Machine\Scripts</TargetFilename>
      <TargetFilename condition="end with">.cmd</TargetFilename>
      <TargetFilename condition="end with">.pptm</TargetFilename>
      <TargetFilename condition="end with">.sln</TargetFilename>
      <TargetFilename condition="contains">\Startup</TargetFilename>
      <TargetFilename condition="end with">.ps2</TargetFilename>
      <TargetFilename condition="end with">.exe</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\System32\WindowsPowerShell</TargetFilename>
      <TargetFilename condition="contains">\Content.Outlook\</TargetFilename>
      <TargetFilename condition="end with">.bat</TargetFilename>
	  
	  <!-- relevant for web servers
        https://www.secureworks.com/research/threat-group-3390-targets-organizations-for-cyberespionage
		https://www.rsaconference.com/writable/presentations/file_upload/hta-f02-detecting-and-responding-to-advanced-threats-within-exchange-environments.pdf
		https://github.com/tennc/webshell/blob/master/net-friend/aspx/aspxspy.aspx
	  -->
	  <TargetFilename condition="end with">.jsp</TargetFilename> 
	  <TargetFilename condition="end with">.jspx</TargetFilename> 
	  <TargetFilename condition="end with">.asp</TargetFilename> 
	  <TargetFilename condition="end with">.aspx</TargetFilename> 
	  <TargetFilename condition="end with">.php</TargetFilename> 
	  <TargetFilename condition="end with">.war</TargetFilename>
	  <TargetFilename condition="contains">Exchange Server\ClientAccess\Owa\</TargetFilename> <!-- webshell stuff on exchange CAS -->
	  <TargetFilename condition="contains">\inetpub\wwwroot\</TargetFilename> <!-- webshell stuff -->
	  
      <TargetFilename condition="begin with" >C:\Windows\SysWOW64\Drivers</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\SysWOW64\WindowsPowerShell</TargetFilename>
      <TargetFilename condition="contains">\Start Menu</TargetFilename>
	  <TargetFilename condition="contains" name="persistence - office templates trusted location">AppData\Roaming\Microsoft\Templates</TargetFilename>
	  <TargetFilename condition="end with" name="persistence - backdoored default docm template">Templates\Normal.dotm</TargetFilename>
	  <TargetFilename condition="end with" name="persistence - backdoored outlook template">NormalEmail.dotm</TargetFilename>
	  <TargetFilename condition="end with" name="persistence - backdoored excel default macro template">XLSTART\PERSONAL.XLSB</TargetFilename>
	  <TargetFilename condition="contains" name="persistence - Word Library Add-Ins">Roaming\Microsoft\Word\Startup\</TargetFilename>
	  <TargetFilename condition="contains" name="persistence - Excel VBA Add-Ins">Roaming\Microsoft\Excel\XLSTART\</TargetFilename>
	  <TargetFilename condition="contains" name="persistence - Powerpoint and Excel VBA Add-Ins Trusted Location">Roaming\Microsoft\AddIns</TargetFilename>
      <TargetFilename condition="end with">.sys</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\System32\Drivers</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\SysWOW64\Wbem</TargetFilename>
      <TargetFilename condition="end with">.*proj</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\System32\Tasks</TargetFilename>
	  <!-- known bad file names -->
	  <TargetFilename condition="end with">rdpwrap.dll</TargetFilename><!-- -->
	  <TargetFilename condition="end with">BootStrapDLL.dll</TargetFilename><!-- KeeFarce.exe default injected DLL name-->
	  <!-- add Tymur slides content and add https://github.com/Neo23x0/sigma/blob/master/rules/windows/sysmon/sysmon_powershell_exploit_scripts.yml for ps -->
	  
      <!-- side loading -->
	  <TargetFilename condition="end with">ssMUIDLL.dll</TargetFilename> <!-- op cell phone - https://www.cybereason.com/blog/operation-soft-cell-a-worldwide-campaign-against-telecommunications-providers -->
	  <TargetFilename condition="end with">credwiz.exe</TargetFilename> <!-- side loading with legit credwiz.exe https://app.any.run/tasks/3fcfd265-ef80-4749-a24b-39364a079802 -->
      <TargetFilename condition="end with">NvSmartMaxapp.dll</TargetFilename> <!--DLL side loading: https://quequero.org/2013/09/quick-analysissome-observation-about-a-low-detection-flash_update-exe/ -->
	  <TargetFilename condition="end with">NvSmartMax.dll</TargetFilename>
	  <TargetFilename condition="end with">mcvsmap.exe</TargetFilename>
	  <TargetFilename condition="end with">jli.dll</TargetFilename> <!-- APT10 use jjs.exe for dll side loading jli.dll https://blog.ensilo.com/uncovering-new-activity-by-apt10 -->
      <TargetFilename condition="end with">AShld.exe</TargetFilename>
      <TargetFilename condition="end with">AShldRes.DLL</TargetFilename>
      <TargetFilename condition="end with">AShldRes.DLL.asr</TargetFilename>
      <TargetFilename condition="end with">CamMute.exe</TargetFilename>
      <TargetFilename condition="end with">CommFunc.dll</TargetFilename>
      <TargetFilename condition="end with">CommFunc.jax</TargetFilename>
      <TargetFilename condition="end with">chrome_frame_helper.exe</TargetFilename>
      <TargetFilename condition="end with">chrome_frame_helper.dll</TargetFilename>
      <TargetFilename condition="end with">chrome_frame_helper.dll.rom</TargetFilename>
      <TargetFilename condition="end with">dvcemumanager.exe</TargetFilename>
      <TargetFilename condition="end with">DESqmWrapper.dll</TargetFilename>
      <TargetFilename condition="end with">DESqmWrapper.wrapper</TargetFilename>
      <TargetFilename condition="end with">fsguidll.exe</TargetFilename>
      <TargetFilename condition="end with">fslapi.dll</TargetFilename>
      <TargetFilename condition="end with">fslapi.dll.gui</TargetFilename>
      <TargetFilename condition="end with">fsstm.exe</TargetFilename>
      <TargetFilename condition="end with">FSPMAPI.dll</TargetFilename>
      <TargetFilename condition="end with">FSPMAPI.dll.fsp</TargetFilename>
      <TargetFilename condition="end with">Gadget.exe</TargetFilename>
      <TargetFilename condition="end with">Sidebar.dll</TargetFilename>
      <TargetFilename condition="end with">Sidebar.dll.doc</TargetFilename>
      <TargetFilename condition="end with">hhc.exe</TargetFilename>
      <TargetFilename condition="end with">hha.dll</TargetFilename>
      <TargetFilename condition="end with">hha.dll.bak</TargetFilename>
      <TargetFilename condition="end with">hkcmd.exe</TargetFilename>
      <TargetFilename condition="end with">hccutils.dll</TargetFilename>
      <TargetFilename condition="end with">hccutils.dll.res</TargetFilename>
      <TargetFilename condition="end with">LoLTWLauncher.exe</TargetFilename>
      <TargetFilename condition="end with">NtUserEx.dll</TargetFilename>
      <TargetFilename condition="end with">NtUserEx.dat</TargetFilename>
      <TargetFilename condition="end with">Mc.exe</TargetFilename>
      <TargetFilename condition="end with">McUtil.dll</TargetFilename>
      <TargetFilename condition="end with">McUtil.dll.url</TargetFilename>
      <TargetFilename condition="end with">mcf.exe</TargetFilename>
      <TargetFilename condition="end with">mcf.ep</TargetFilename>
      <TargetFilename condition="end with">mcupdui.exe</TargetFilename>
      <TargetFilename condition="end with">McUtil.dll.ping</TargetFilename>
      <TargetFilename condition="end with">mcut.exe</TargetFilename>
      <TargetFilename condition="end with">mcutil.dll.bbc</TargetFilename>
      <TargetFilename condition="end with">MsMpEng.exe</TargetFilename>
      <TargetFilename condition="end with">MpSvc.dll</TargetFilename>
      <TargetFilename condition="end with">msseces.exe</TargetFilename>
      <TargetFilename condition="end with">mPclient.dll</TargetFilename>
      <TargetFilename condition="end with">msseces.asm</TargetFilename>
      <TargetFilename condition="end with">NvSmart.exe</TargetFilename>
      <TargetFilename condition="end with">NvSmartMax.dll</TargetFilename>
      <TargetFilename condition="end with">boot.ldr</TargetFilename>
      <TargetFilename condition="end with">OInfoP11.exe</TargetFilename>
      <TargetFilename condition="end with">OInfo11.ocx</TargetFilename>
      <TargetFilename condition="end with">OInfo11.ISO</TargetFilename>
      <TargetFilename condition="end with">OleView.exe</TargetFilename>
      <TargetFilename condition="end with">ACLUI.DLL</TargetFilename>
      <TargetFilename condition="end with">ACLUI.DLL.UI</TargetFilename>
      <TargetFilename condition="end with">OleView.exe</TargetFilename>
      <TargetFilename condition="end with">iviewers.dll</TargetFilename>
      <TargetFilename condition="end with">POETWLauncher.exe</TargetFilename>
      <TargetFilename condition="end with">NtUserEx.dll</TargetFilename>
      <TargetFilename condition="end with">NtUserEx.dat</TargetFilename>
      <TargetFilename condition="end with">RasTls.exe</TargetFilename>
      <TargetFilename condition="end with">RasTls.dll</TargetFilename>
      <TargetFilename condition="end with">RasTls.dll.msc</TargetFilename>
      <TargetFilename condition="end with">RasTls.dll.config</TargetFilename><!-- https://www.hybrid-analysis.com/sample/0fb0636a2823e8fb63681b6bf9d1dd910c7a1e3ed27d19fda1db11dda8e578f8?environmentId=100 -->
      <TargetFilename condition="end with">rc.exe</TargetFilename>
      <TargetFilename condition="end with">rc.dll</TargetFilename>
      <TargetFilename condition="end with">rc.hlp</TargetFilename>
      <TargetFilename condition="end with">RunHelp.exe</TargetFilename>
      <TargetFilename condition="end with">ssMUIDLL.dll</TargetFilename>
      <TargetFilename condition="end with">ssMUIDLL.dll.conf</TargetFilename>
      <TargetFilename condition="end with">sep_NE.exe</TargetFilename>
      <TargetFilename condition="end with">winmm.dll</TargetFilename>
      <TargetFilename condition="end with">sep_NE.slf</TargetFilename>
      <TargetFilename condition="end with">msi.dll</TargetFilename>
      <TargetFilename condition="end with">msi.dll.dat</TargetFilename>
      <TargetFilename condition="end with">tplcdclr.exe</TargetFilename>
      <TargetFilename condition="end with">wts.chm</TargetFilename>
      <TargetFilename condition="end with">Ushata.exe</TargetFilename>
      <TargetFilename condition="end with">Ushata.dll</TargetFilename>
      <TargetFilename condition="end with">Ushata.fox</TargetFilename>
      <TargetFilename condition="end with">VeetlePlayer.exe</TargetFilename>
      <TargetFilename condition="end with">libvlc.dll</TargetFilename>
      <TargetFilename condition="end with">mtcReport.ktc</TargetFilename>
      <TargetFilename condition="end with">AFLogVw.exe</TargetFilename>
      <TargetFilename condition="end with">AhnI2.dll</TargetFilename>
	  <!-- finfisher employed dll side loading https://www.microsoft.com/security/blog/2018/03/01/finfisher-exposed-a-researchers-tale-of-defeating-traps-tricks-and-complex-virtual-machines/-->
	  <TargetFilename condition="end with">aepic.dll</TargetFilename>
	  <TargetFilename condition="end with">ftllib.dll</TargetFilename>
	  <TargetFilename condition="end with">userenv.dll</TargetFilename>
	  
	  <!-- chrome extension -->
	  <TargetFilename condition="contains" name="New Chrome Extension Detected">Google\Chrome\User Data\Default\Extensions</TargetFilename>
	  <TargetFilename condition="begin with" name="Persistence - PowerShell default profile">c:\Windows\Syswow64\WindowsPowerShell\v1.0\profile</TargetFilename>
	  <TargetFilename condition="begin with" name="Persistence - PowerShell default profile">c:\Windows\System32\WindowsPowerShell\v1.0\profile</TargetFilename>
	  <!-- warning just for test purposes -->
	  <!--<TargetFilename condition="begin with">c:\windows\system32\</TargetFilename>
	  <TargetFilename condition="begin with">c:\windows\syswow64\</TargetFilename>-->
    </FileCreate>
	
	<!-- FileCreate - Exclusion Section -->
    <FileCreate onmatch="exclude">
	  <Image condition="end with">Services\Microsoft.VisualStudio.Setup.Service\BackgroundDownload.exe</Image>
	  <Image condition="begin with">C:\Program Files\HP Inc\</Image>
	  <Image condition="begin with">C:\Program Files (x86)\Trend Micro\</Image>
	  <Image>C:\WINDOWS\system32\cleanmgr.exe</Image>
	  <Image condition="end with">csc.exe</Image>
      <Image>C:\Program Files\Common Files\Microsoft Shared\ClickToRun\OfficeC2RClient.exe</Image>
      <Image condition="begin with" >C:\WINDOWS\winsxs\amd64_microsoft-windows</Image>
      <Image>C:\Program Files (x86)\Dell\CommandUpdate\InvColPC.exe</Image>
      <Image>C:\Windows\system32\igfxCUIService.exe</Image>
      <Image>C:\Windows\system32\CompatTelRunner.exe</Image>
      <Image>C:\Windows\System32\smss.exe</Image>
      <Image>C:\Windows\system32\wbem\WMIADAP.EXE</Image>
	  <Image>C:\WINDOWS\system32\TokenBrokerCookies.exe</Image>
	  <TargetFilename condition="end with">Roaming\Microsoft\Windows\Start Menu\Programs\Startup\desktop.ini</TargetFilename>
	  <TargetFilename condition="begin with">C:\Windows\assembly\NativeImages</TargetFilename><!-- noisy for .dll extension -->
	  <TargetFilename condition="contains">AppData\Local\Microsoft\Windows\Temporary Internet Files\Content.IE</TargetFilename> <!-- noisy for web extensions like .aspx -->
	  <TargetFilename condition="begin with">C:\Windows\ServiceProfiles\NetworkService\AppData\Local\Temp\</TargetFilename> <!-- noisy for .dll extensions -->
	  <TargetFilename condition="contains">AppData\Local\Microsoft\Outlook</TargetFilename>
      <TargetFilename condition="begin with" >C:\Windows\System32\wbem\Performance\</TargetFilename>
	  <TargetFilename condition="end with">StartupProfileData-NonInteractive</TargetFilename>
	  <TargetFilename>C:\Windows\Tasks\SA.DAT</TargetFilename> <!-- False Positive -->
	  <TargetFilename condition="begin with">C:\Windows\System32\wdi\</TargetFilename>
	  <TargetFilename condition="end with" >.png</TargetFilename>
	  <TargetFilename condition="end with" >.jpg</TargetFilename>
	  <TargetFilename condition="contains">AppData\Roaming\Microsoft\Office\Recent</TargetFilename>
	  <TargetFilename condition="contains">AppData\Roaming\Microsoft\Windows\Recent</TargetFilename>
	  <TargetFilename condition="begin with" >C:\Windows\CcmTemp\</TargetFilename>
	  <TargetFilename condition="begin with">C:\Windows\CCM\</TargetFilename>
      <TargetFilename condition="begin with" >C:\Windows\System32\Tasks\Microsoft\Windows\SoftwareProtectionPlatform\SvcRestartTask</TargetFilename>
      <TargetFilename condition="end with" >WRITABLE.TST</TargetFilename>
      <TargetFilename condition="begin with">C:\Windows\System32\DriverStore\Temp\</TargetFilename>
	  <TargetFilename condition="begin with"> C:\Windows\SoftwareDistribution\</TargetFilename> <!-- noisy for .cab extension -->
	  <TargetFilename>C:\Windows\System32\Tasks\Microsoft\Windows Defender\MP Scheduled Scan</TargetFilename>
      <TargetFilename condition="begin with" >C:\$WINDOWS.~BT\Sources\SafeOS\SafeOS.Mount\</TargetFilename>
      <TargetFilename condition="begin with" >C:\Windows\System32\Tasks\Microsoft\Windows\PLA\FabricTraces</TargetFilename>
      <TargetFilename condition="begin with" >C:\Windows\System32\Tasks\Microsoft\Windows\Customer Experience Improvement Program\Server\ServerRoleUsageCollector</TargetFilename>
      <TargetFilename condition="begin with" >C:\Windows\System32\Tasks\Microsoft\Windows\Customer Experience Improvement Program\Server\ServerCeipAssistant</TargetFilename>
    </FileCreate>

<!--
Rigistery Events
-->

    <RegistryEvent onmatch="include">
	  <!-- <TargetObject name="Defense Evasion - Removes Office resiliency keys" condition="contains">RESILIENCY\STARTUPITEMS</TargetObject> -->
	  <!-- startup regkeys -->
	  <TargetObject condition="end with" name="Persistence - Startup User Shell Folder Modified">software\microsoft\windows\currentversion\explorer\user shell folders\startup</TargetObject> <!-- https://app.any.run/tasks/60700042-753e-4f5f-814c-5297d8423cc2/ -->
	  <!-- RDP Hijack related keys -->
	  <!-- https://www.fireeye.com/blog/threat-research/2019/01/bypassing-network-restrictions-through-rdp-tunneling.html -->
	  <TargetObject condition="contains">services\TermService\Parameters\ServiceDll</TargetObject>
	  <TargetObject condition="contains">\environment</TargetObject><!-- enviornment variables changes -->
      <TargetObject condition="contains">Control\Terminal Server\fSingleSessionPerUser</TargetObject>
      <TargetObject condition="end with">fDenyTSConnections</TargetObject>
      <TargetObject condition="contains">LastLoggedOnUser</TargetObject>
      <TargetObject condition="contains">RDP-tcp\PortNumber</TargetObject>
	  <TargetObject condition="contains">Services\PortProxy\v4tov4</TargetObject>
      <TargetObject condition="contains">SoftWare\SimonTatham\PuTTY</TargetObject>	
      <TargetObject condition="end with" name="Lateral Movement - New Named Pipe added to NullSession">NullSessionPipes</TargetObject>
	  <TargetObject condition="contains" name="Lateral Movement - New Named Pipe added to NullSession">NullSessionShares</TargetObject>
	  <TargetObject condition="contains" name="Persistence - new svchost service">SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost</TargetObject>
	  <!-- Steals printed documents from spooler queue -->
	  <TargetObject condition="end with">printers\DefaultSpoolDirectory</TargetObject> <!-- can be abused to redirect spooler queue -->
	  <TargetObject condition="end with">SpoolDirectory</TargetObject> <!-- can be abused to redirect spooler queue -->
	  <TargetObject condition="contains">DsSpooler\printKeepPrintedJobs</TargetObject> <!-- https://securelist.com/project-tajmahal/90240/ -->
      <!-- UAC Bypass related stuff -->
      <TargetObject condition="contains">Software\Microsoft\Windows\CurrentVersion\App Paths\control.exe</TargetObject>	  
	  
	  <!-- Making a system vulnerable -->
	  <TargetObject condition="end with" name="Defense Evasion - PowerShell ExecPolicy Changed">Microsoft.PowerShell\ExecutionPolicy</TargetObject>
	  <TargetObject condition="end with" name="Defense Evasion - PowerShell Audit Settings Changed">EnableModuleLogging</TargetObject>
	  <TargetObject condition="end with" name="Defense Evasion - PowerShell Audit Settings Changed">EnableScriptBlockLogging</TargetObject>
	  <TargetObject condition="contains" name="Defense Evasion - PowerShell Audit Settings Changed">PowerShell\Transcription</TargetObject>
      <TargetObject condition="end with" name="Defense Evasion - access to the VBA project object model in the Macro Settings changed">AccessVBOM</TargetObject><!--https://www.stigviewer.com/stig/microsoft_powerpoint_2007/2014-04-03/finding/V-17522 -->
	  <TargetObject condition="contains" name="Defense Evasion - Changes to ProtectedView Security Setting">Security\ProtectedView</TargetObject>
	  <TargetObject condition="contains" name="Defense Evasion - Office Trusted Locations changed">Security\Trusted Locations</TargetObject> <!-- can be abused to execute unrestricted vba from specific desired locations -->
	  <TargetObject condition="end with" name="Defense Evasion - Lsa Protection changed">SYSTEM\CurrentControlSet\Control\Lsa\RunAsPPL</TargetObject>
	  <TargetObject condition="contains" name="Defense Evasion - Wdigest Enabled">\Control\SecurityProviders\WDigest\UseLogonCredential</TargetObject>
	  
	  <TargetObject condition="end with">\TreatAs</TargetObject><!-- CLSID or COM Objects changes, very important to watch it -->
	  <!-- Office Persistence - https://labs.mwrinfosecurity.com/blog/add-in-opportunities-for-office-persistence/ -->
	  <TargetObject condition="contains" name="Persistence - Outlook COM Addins">\Outlook\Addins</TargetObject>
	  <TargetObject condition="contains" name="Persistence - Excel COM Addins">\Excel\Addins</TargetObject>
	  <TargetObject condition="contains" name="Persistence - Excel Addins">Excel\Options\OPEN</TargetObject>
	  <TargetObject condition="contains" name="Persistence - Word COM Addins">\Word\Addins</TargetObject>
	  <TargetObject condition="contains" name="Persistence - Access COM Addins">\Access\Addins\</TargetObject>
	  <TargetObject condition="contains" name="Persistence - Powerpoint COM Addins">\Powerpoint\Addins\</TargetObject>
	  <TargetObject condition="contains" name="Persistence - VBE Addins">Software\Microsoft\VBA\VBE\6.0\Addins</TargetObject>
	  <TargetObject condition="end with" name="Persistence - Macro Auto Loading enabled on outlook">Outlook\LoadMacroProviderOnBoot</TargetObject>
	  
	  <TargetObject condition="contains" name="Persistence via SilentProcessExit hijack">CurrentVersion\SilentProcessExit</TargetObject>
	  
      <TargetObject condition="contains">SYSTEM\CurrentControlSet\services\SysmonDrv</TargetObject>
      <TargetObject condition="end with">\PsService\EulaAccepted</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection\DisableBehaviorMonitoring</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\DisableAntiVirus</TargetObject>
      <TargetObject condition="end with">\PsLoggedOn\EulaAccepted</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\WOW6432Node\Microsoft\Cryptography\Providers\Trust</TargetObject>
	  <!-- Per-user ASEPs under HKCU\Software -->
      <TargetObject condition="contains" >\InprocServer32\</TargetObject> <!-- COM Stuff -->
      <TargetObject condition="contains">\CurrentVersion\Run</TargetObject>
	  <TargetObject condition="contains">\Software\Microsoft\Windows NT\CurrentVersion\Windows\Load</TargetObject>
      <TargetObject condition="end with">\PsInfo\EulaAccepted</TargetObject>
      <TargetObject condition="contains" name="Persistence - Application Shimming">CurrentVersion\AppCompatFlags\InstalledSDB</TargetObject>
      <TargetObject condition="contains" >\shell\open\ddeexec</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection\DisableScanOnRealtimeEnable</TargetObject>
      <TargetObject condition="end with" >\Start</TargetObject>
      <TargetObject condition="contains">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\W32Time\TimeProviders</TargetObject>
      <TargetObject condition="begin with">HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors</TargetObject>
      <TargetObject condition="contains" >\ContextMenuHandlers</TargetObject>
      <TargetObject condition="end with" >\PsSuspend\EulaAccepted</TargetObject>
      <TargetObject condition="contains">SOFTWARE\Microsoft\Netsh</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Security Center\DisableMonitoring</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Security Center\AllAlertsDisabled</TargetObject>
      <TargetObject condition="begin with">HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\InitialProgram</TargetObject>
      <TargetObject condition="contains">ms-settings\shell\open\command</TargetObject>
      <TargetObject condition="end with">\PsList\EulaAccepted</TargetObject>
      <TargetObject condition="contains">Classes\exefile\shell\runas\command\isolatedCommand</TargetObject>
      <TargetObject condition="begin with" name="Defense Evasion - UAC Bypass">HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\EnableLUA</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection\DisableOnAccessProtection</TargetObject>
      <!-- "technique_id=T1130,technique_name=Install Root Certificate">\Microsoft\SystemCertificates\Root\Certificates - disabled by sb too many fp -->
      <TargetObject condition="begin with" >HKLM\Software\Microsoft\Windows\CurrentVersion\explorer\ShellServiceObjectDelayLoad</TargetObject>
      <TargetObject condition="begin with" >HKLM\SYSTEM\CurrentControlSet\Control\Winlogon</TargetObject>
      <!-- TargetObject condition="contains"  \Internet Explorer\Toolbar - disabled by sb too many fp-->
      <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Custom</TargetObject>
      <TargetObject condition="begin with">HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet\SpyNetReporting</TargetObject>
      
      <TargetObject condition="end with">\PsLogList\EulaAccepted</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Image File Execution Options</TargetObject>
      <TargetObject condition="contains">SYSTEM\CurrentControlSet\services\Sysmon</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\Appinit_Dlls</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Security Center\UacDisableNotify</TargetObject>
      <TargetObject condition="end with" >\FriendlyName</TargetObject>
      <TargetObject condition="contains" >\Browser Helper Objects</TargetObject>
      <TargetObject condition="end with">\PsKill\EulaAccepted</TargetObject>
      <TargetObject condition="contains">\Explorer\FileExts</TargetObject>
      <TargetObject condition="begin with" >HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Authentication\Credential Provider</TargetObject>
      <TargetObject condition="end with" >\ImagePath</TargetObject>
      <TargetObject condition="begin with" name="Persistance via bootexecutee smss.exe">HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\BootExecute</TargetObject>
      <TargetObject condition="begin with">HKLM\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile\AuthorizedApplications\List</TargetObject>
      <TargetObject condition="begin with" >HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows NT\CurrentVersion\Drivers32</TargetObject>
      <TargetObject condition="contains">SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\LSASS.exe</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</TargetObject>
      <TargetObject condition="contains" >\shell\install\command</TargetObject>
      <TargetObject >HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Setup\ServiceStartup</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Cryptography\OID</TargetObject>
      <TargetObject condition="contains" >\Classes\Directory</TargetObject>
      <TargetObject condition="contains">\mscfile\shell\open\command</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System</TargetObject>
      <TargetObject condition="begin with" >HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths</TargetObject>
      <TargetObject condition="end with">\PsFile\EulaAccepted</TargetObject>
      <TargetObject condition="contains">\Policies\Explorer\Run</TargetObject>
      <TargetObject condition="end with" name="Persistence - Winlogon Shell">CurrentVersion\Winlogon\Shell</TargetObject>
      <TargetObject condition="end with" name="Persistence - New svchost hosted service">Parameters\ServiceDll</TargetObject>
      <TargetObject condition="contains">\Windows\System\Scripts</TargetObject>
      <TargetObject condition="begin with" >HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT</TargetObject>
      <TargetObject condition="contains">\Classes\Folder</TargetObject>
      <TargetObject condition="contains">\shell\open\command</TargetObject>
      <TargetObject>HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Security Center\FirewallDisableNotify</TargetObject>
      <TargetObject condition="begin with">HKLM\SYSTEM\CurrentControlSet\Control\Safeboot</TargetObject>
      <TargetObject condition="end with">\ProxyServer</TargetObject>
      <TargetObject condition="end with">\PsShutDown\EulaAccepted</TargetObject>
      <TargetObject condition="contains">\services\Netlogon\Parameters\DisablePasswordChange</TargetObject>
      <TargetObject condition="contains">{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}</TargetObject>
      <TargetObject condition="contains">\Internet Explorer\Extensions</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Security Center\AntiVirusDisableNotify</TargetObject>
      <TargetObject condition="end with">\PsGetSID\EulaAccepted</TargetObject>
      <TargetObject condition="begin with" >HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GPExtensions</TargetObject>
      <TargetObject condition="contains">\CurrentVersion\Shell</TargetObject>
      <TargetObject condition="begin with">HKLM\SYSTEM\CurrentControlSet\Services\WinSock</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\WOW6432Node\Microsoft\Cryptography\OID</TargetObject>
      <TargetObject condition="end with">\PsExec\EulaAccepted</TargetObject>
      <TargetObject>REGISTRY\MACHINE\SYSTEM\ControlSet001\Services\DNS\Parameters\ServerLevelPluginDll</TargetObject>
      <TargetObject condition="begin with">HKLM\Software\Microsoft\Windows\CurrentVersion\explorer\ShellExecuteHooks</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Cryptography\Providers\Trust</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\DisableAntiSpyware</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender</TargetObject>
      <TargetObject condition="begin with">HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SecurityProviders</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Security Center\FirewallOverride</TargetObject>
      <TargetObject>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options</TargetObject>
      <TargetObject condition="contains">SYSTEM\CurrentControlSet\Control\CrashControl</TargetObject>
      <TargetObject >HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\InProgress\(Default)</TargetObject>
      <TargetObject condition="end with">\PsPasswd\EulaAccepted</TargetObject>
      <TargetObject condition="contains">\Classes\Drive</TargetObject>
      <TargetObject condition="begin with">HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Authentication</TargetObject><!-- updated by sb by adding Authentication Packages value -->
      <TargetObject condition="end with">\UrlUpdateInfo</TargetObject>
      <!--technique_id=T1130,technique_name=Install Root Certificate" HKLM\SOFTWARE\Microsoft\EnterpriseCertificates\Root\Certificates - disabled by sb generate lot of sysmon 12 -->
      <TargetObject condition="contains">\Classes\AllFilesystemObjects</TargetObject>
      <TargetObject condition="contains">Software\Classes\CLSID</TargetObject>
	
	  <TargetObject condition="end with" name="Persistence - First Time Seen Shell Extension">\CurrentVersion\Shell Extensions\Cached</TargetObject><!-- focus on the ones under HKCU not HKLM or HKEY_CLASSES_ROOT -->
	  
	  <!-- 
	  good resource - https://github.com/the80srobot/t8r-volatility/blob/master/persistence.py 
	  https://static1.squarespace.com/static/552092d5e4b0661088167e5c/t/5a00963153450a8779b23489/1509987890282/Windows
	  https://www.carbonblack.com/cbfeeds/earlyaccess_feed.xhtml
	  -->
	  
      <TargetObject condition="contains">\Group Policy\Scripts</TargetObject>
      <TargetObject condition="begin with">HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\AppCertDlls</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Security Center\UpdatesDisableNotify</TargetObject>
      <TargetObject condition="begin with">HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options</TargetObject>
      <TargetObject condition="begin with">HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows\Appinit_Dlls</TargetObject>
    </RegistryEvent>
	
	<!-- RegistryEvent - Exclusion Section -->
	
    <RegistryEvent onmatch="exclude">
	  <EventType condition="is">CreateKey</EventType>
	  <!-- <EventType condition="is">DeleteKey</EventType> -->
	  <Image>C:\WINDOWS\Sysmon.exe</Image>
	  <Image>C:\WINDOWS\Sysmon64.exe</Image>
	  <Image>C:\Windows\System32\smss.exe</Image>
	  <Image condition="begin with">C:\Program Files (x86)\Trend Micro\</Image>
	  <Image condition="begin with">C:\Program Files\Trend Micro\</Image>
      <Image >C:\Windows\SystemApps\Microsoft.Windows.Cortana_cw5n1h2txyewy\SearchUI.exe</Image>
      <Image condition="end with" >Office\root\integration\integrator.exe</Image>
      <Image >C:\Program Files\Common Files\Microsoft Shared\ClickToRun\OfficeClickToRun.exe</Image>
      <Image condition="image" >C:\WINDOWS\system32\backgroundTaskHost.exe</Image>
      <Image >C:\Program Files\WIDCOMM\Bluetooth Software\btwdins.exe</Image>
      <Image >C:\Program Files (x86)\Webroot\WRSA.exe</Image>
      <Image >C:\Program Files\Windows Defender\MsMpEng.exe</Image>
	  <Image>C:\WINDOWS\system32\LogonUI.exe</Image>
	  <Image>C:\Program Files\Microsoft Office\root\Office16\lync.exe</Image>
	  <Image>C:\WINDOWS\CCM\CcmExec.exe</Image>
	  <Image condition="end with">AppData\Local\Microsoft\OneDrive\OneDrive.exe</Image>
	  <Image condition="end with">AppData\Local\Microsoft\Teams\current\Teams.exe</Image>
	  <Image condition="end with">Procmon.exe</Image>
	  <Image condition="end with">Proexp64.exe</Image>
	  <Image condition="end with">Autoruns.exe</Image>
	  <Image>C:\Windows\System32\unregmp2.exe</Image>
      <Image condition="begin with" >C:\$WINDOWS.~BT\</Image>
	  <TargetObject>HKLM\System\CurrentControlSet\Control\CrashControl\CrashDumpEnabled</TargetObject>
	  <TargetObject>HKLM\SOFTWARE\Policies\Microsoft\Windows\NetworkConnectivityAssistant\FriendlyName</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\exclusions\processes\%windir%\System32\</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\exclusions\paths\C:\Program Files\</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\exclusions\processes\%ProgramFiles%\</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\exclusions\processes\%ProgramFiles(x86)%</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Appx\NewDeploymentOperation</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\exclusions\processes\%windir%\CCM\</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\exclusions\paths\%windir%\SoftwareDistribution</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\exclusions\paths\%windir%\Security\</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\signature updates\</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\legalnoticecaption</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\legalnoticetext</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\maxdevicepasswordfailedattempts</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\exclusions\processes\%ProgramFiles</TargetObject>
	  <TargetObject condition="begin with">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\AppReadiness</TargetObject>
	  <TargetObject condition="contains">Software\Microsoft\Windows\CurrentVersion\AppModel\PackageRepository</TargetObject>
      <TargetObject condition="end with" >\services\BITS\Start</TargetObject>
	  <TargetObject condition="end with">DateLastConnected</TargetObject>
      <TargetObject condition="end with" >\services\clr_optimization_v4.0.30319_64\Start</TargetObject>
      <TargetObject condition="end with" >HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit</TargetObject>
      <TargetObject condition="begin with" >HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\</TargetObject>
      <TargetObject condition="end with" >HKLM\SYSTEM\CurrentControlSet\Services\UsoSvc\Start</TargetObject>
      <TargetObject condition="end with" >\Components\TrustedInstaller\Events</TargetObject>
      <TargetObject condition="end with" >HKLM\SYSTEM\CurrentControlSet\Control\Lsa\SspiCache</TargetObject>
      <TargetObject condition="contains" >\OpenWithProgids</TargetObject>
      <TargetObject condition="end with" >HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Audit\PerUserAuditing\System</TargetObject>
      <TargetObject condition="end with" >\services\clr_optimization_v4.0.30319_32\Start</TargetObject>
      <TargetObject condition="end with" >\Directory\shellex\DragDropHandlers</TargetObject>
      <TargetObject condition="end with" >\services\TrustedInstaller\Start</TargetObject>
      <TargetObject condition="end with" >\OpenWithList\MRUList</TargetObject>
      <TargetObject condition="end with" >HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Kerberos\Domains</TargetObject>
      <TargetObject condition="end with" >\OpenWithList</TargetObject>
      <TargetObject condition="end with" >\Directory\shellex</TargetObject>
      <TargetObject condition="end with" >\services\clr_optimization_v2.0.50727_64\Start</TargetObject>
      <TargetObject condition="contains" >_Classes\AppX</TargetObject>
      <!-- why exluded <TargetObject condition="end with" >\CurrentVersion\Shell Extensions\Approved</TargetObject> -->
      <TargetObject condition="end with" >\services\UsoSvc\Start</TargetObject>
      <TargetObject condition="end with" >\UserChoice\Hash</TargetObject>
      <TargetObject condition="end with" >\services\tunnel\Start</TargetObject>
      <TargetObject condition="end with" >Toolbar\WebBrowser\ITBar7Height</TargetObject>
      <TargetObject condition="end with" >\Components\Wlansvc</TargetObject>
      <TargetObject condition="end with" >\CurrentVersion\Image File Execution Options</TargetObject>
      <TargetObject condition="end with" >\services\clr_optimization_v2.0.50727_32\Start</TargetObject>
      <TargetObject condition="end with" >HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Audit\AuditPolicy</TargetObject>
      <TargetObject condition="end with" >\services\DeviceAssociationService\Start</TargetObject>
      <TargetObject condition="begin with" >HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Publishers\</TargetObject>
      <TargetObject condition="end with" >Internet Explorer\Toolbar\Locked</TargetObject>
      <TargetObject condition="end with" >ShellBrowser</TargetObject>
      <TargetObject condition="end with" >Toolbar\ShellBrowser\ITBar7Layout</TargetObject>
      <TargetObject condition="end with" >\Lsa\OfflineJoin\CurrentValue</TargetObject>
      <TargetObject condition="end with" >Toolbar\WebBrowser</TargetObject>
      <TargetObject condition="end with" >}\PreviousPolicyAreas</TargetObject>
      <TargetObject condition="end with" >\UserChoice\ProgId</TargetObject>
      <TargetObject condition="contains" >\Control\WMI\Autologger\</TargetObject>
      <TargetObject condition="end with" >\Drive\shellex\DragDropHandlers</TargetObject>
      <TargetObject condition="end with" >\Drive\shellex</TargetObject>
      <TargetObject condition="end with" >HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Audit</TargetObject>
      <TargetObject condition="end with" >\CurrentVersion\App Paths</TargetObject>
      <TargetObject condition="end with" >\Components\TrustedInstaller</TargetObject>
      <TargetObject condition="end with" >} 0xFFFF</TargetObject>
      <TargetObject condition="end with" >\Components\Wlansvc\Events</TargetObject>
      <TargetObject condition="end with" >\UserChoice</TargetObject>
    </RegistryEvent>
<!--
File Create Stream Hash
-->
  
	<FileCreateStreamHash onmatch="exclude">
	<Hash condition="end with">IMPHASH=00000000000000000000000000000000</Hash><!-- exclude non executable files -->
	</FileCreateStreamHash>
	
<!--
PipeEvent
-->
<!-- common network named pipes https://raw.githubusercontent.com/peterpt/pipe_auditor_fb/master/pipe_audit_v2.rb 
https://github.com/dzonerzy/winescalation
-->

    <PipeEvent onmatch="include">
	  <!-- known bad named pipes - malwares, subject to regular updates -->
	  <PipeName condition="contains">\msagent_</PipeName> 
	  <PipeName name="lateral movement - psexec detected">\PSEXESVC</PipeName>
	  <PipeName condition="contains" name="meterpreter named pipe">msf-pipe </PipeName>
	  <!-- known legit named pipes, useful for detecting recon and some lateral movement tricks -->	  
	  <PipeName condition="contains">\atsvc</PipeName> <!-- useful for lm or exec over atsvc namedpipe -->
	  <PipeName condition="contains">\srvsvc</PipeName> <!-- useful for smb sessions enum detection-->
	  <PipeName condition="contains">\winreg</PipeName> <!-- useful for lateral movement and users enumeration, psloggedon use thise technique -->
	  <Image>System</Image> <!-- experimental - support detection of named pipes that are accessible over SMB -->
    </PipeEvent>
	<!-- PipeEvent Exclusion Config Section -->
	<PipeEvent onmatch="exclude">
	 <Image condition="begin with">c:\windows\system32\</Image>
	 <Image>C:\WINDOWS\Explorer.EXE</Image>
	 <Image condition="begin with">c:\windows\syswow64\</Image>
	 <Image condition="begin with">c:\program files\</Image>
	 <Image condition="begin with">c:\program files (x86)\</Image>
	</PipeEvent>
<!--
WmiEvent
-->
	<WmiEvent onmatch="exclude">
	</WmiEvent>
</EventFiltering>
<!--
Hash Algorithms
 -->
  <HashAlgorithms>*</HashAlgorithms> <!-- make sure imphash is always turned ON, it's used for different inclusion and exclusion rules -->
  <CheckRevocation />
</Sysmon>

<!--
Many tanks to gavz and other friends
-->